#define F_CPU 4915200UL              // Define CPU clock frequency for delay routines
#include <avr/io.h>                 // Include AVR I/O definitions
#include <stdio.h>                  // Include standard I/O (printf)
#include <stdint.h>                 // Include standard integer types (uint8_t, etc.)
#include <avr/pgmspace.h>           // Include program memory access (PROGMEM)
#include <avr/interrupt.h>

#include "OLED.h"
#include "SPI.h"

static inline void oled_cmd(char c, int slave) {
	PORTB &= ~(1 << DISP_DC);               // DC = 0 -> command
	oled_select();                          // Select OLED
	spi_send_byte(c, slave);                  // Send command
	oled_deselect();                        // Deselect OLED
}

static inline void oled_data_byte(char d, int slave) {
	PORTB |= (1 << DISP_DC);                // DC = 1 -> data
	oled_select();                          // Select OLED
	spi_send_byte(d, slave);                       // Send data byte
	oled_deselect();                        // Deselect OLED
}


void oled_init(void) {
	oled_cmd(0xAE); // display off
	oled_cmd(0xA1); // segment remap
	oled_cmd(0xC8); // COM scan direction
	oled_cmd(0xA6); // normal display
	oled_cmd(0xAF); // display on
}


// --- 5x7 font (ASCII 32-90 subset) ---
const uint8_t font5x7[][5] PROGMEM = {
	{0x00,0x00,0x00,0x00,0x00}, // space
	{0x00,0x00,0x5F,0x00,0x00}, // !
	{0x00,0x07,0x00,0x07,0x00}, // "
	{0x14,0x7F,0x14,0x7F,0x14}, // #
	{0x24,0x2A,0x7F,0x2A,0x12}, // $
	{0x23,0x13,0x08,0x64,0x62}, // %
	{0x36,0x49,0x55,0x22,0x50}, // &
	{0x00,0x05,0x03,0x00,0x00}, // '
	{0x00,0x1C,0x22,0x41,0x00}, // (
	{0x00,0x41,0x22,0x1C,0x00}, // )
	{0x7E,0x11,0x11,0x11,0x7E}, // A
	{0x7F,0x49,0x49,0x49,0x36}, // B
	{0x3E,0x41,0x41,0x41,0x22}, // C
	{0x7F,0x41,0x41,0x22,0x1C}, // D
	{0x7F,0x49,0x49,0x49,0x41}, // E
	{0x7F,0x09,0x09,0x09,0x01}, // F
	{0x3E,0x41,0x49,0x49,0x7A}, // G
	{0x7F,0x08,0x08,0x08,0x7F}, // H
	{0x00,0x41,0x7F,0x41,0x00}, // I
	{0x20,0x40,0x41,0x3F,0x01}, // J
	{0x7F,0x08,0x14,0x22,0x41}, // K
	{0x7F,0x40,0x40,0x40,0x40}, // L
	{0x7F,0x02,0x0C,0x02,0x7F}, // M
	{0x7F,0x04,0x08,0x10,0x7F}, // N
	{0x3E,0x41,0x41,0x41,0x3E}, // O
	{0x7F,0x09,0x09,0x09,0x06}, // P
	{0x3E,0x41,0x51,0x21,0x5E}, // Q
	{0x7F,0x09,0x19,0x29,0x46}, // R
	{0x46,0x49,0x49,0x49,0x31}, // S
	{0x01,0x01,0x7F,0x01,0x01}, // T
	{0x3F,0x40,0x40,0x40,0x3F}, // U
	{0x1F,0x20,0x40,0x20,0x1F}, // V
	{0x7F,0x20,0x18,0x20,0x7F}, // W
	{0x63,0x14,0x08,0x14,0x63}, // X
	{0x03,0x04,0x78,0x04,0x03}, // Y
	{0x61,0x51,0x49,0x45,0x43}  // Z
};


void oled_goto(uint8_t col, uint8_t page) {
	oled_cmd(0xB0 | (page & 0x07));        // Set page address (row)
	oled_cmd(0x00 | (col & 0x0F));         // Set lower column address
	oled_cmd(0x10 | ((col >> 4) & 0x0F));  // Set higher column address
}

void oled_putc(char c) {
	if (c < 32 || c > 90) c = '?';         // Replace unsupported chars with '?'
	for (uint8_t i = 0; i < 5; i++) {     // Loop over 5 columns of font
		uint8_t line = pgm_read_byte(&font5x7[c - 32][i]); // Read font from program memory
		oled_data_byte(line);              // Send column data
	}
	oled_data_byte(0x00);                  // Add spacing between characters
}

void oled_puts(const char *s) {
	while (*s) oled_putc(*s++);            // Print string character by character
}
